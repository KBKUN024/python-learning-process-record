"""
è¿™ä¸ªæ–‡ä»¶è¶…çº§è¯¦ç»†çš„è§£é‡Šäº†ï¼šå¸¦å‚æ•°çš„è£…é¥°å™¨æ‰§è¡Œæ—¶æœº
"""
from functools import wraps
from typing import Any, Callable

print("=== è£…é¥°å™¨æ‰§è¡Œæ—¶æœºè¯¦ç»†åˆ†æ ===\n")

def type_check(*expected_types):
    """å‚æ•°åŒ–è£…é¥°å™¨ï¼šæ£€æŸ¥å‡½æ•°å‚æ•°ç±»å‹"""
    print(f"ğŸ”¥ ç¬¬1å±‚æ‰§è¡Œ: type_check({expected_types}) è¢«è°ƒç”¨")
    print("   â†³ è¿™å‘ç”Ÿåœ¨ï¼šPythonè§£é‡Šå™¨é‡åˆ° @type_check(int, str) æ—¶")
    
    def decorator(func: Callable) -> Callable:
        print(f"ğŸ”¥ ç¬¬2å±‚æ‰§è¡Œ: decorator({func.__name__}) è¢«è°ƒç”¨")
        print("   â†³ è¿™å‘ç”Ÿåœ¨ï¼šè£…é¥°å™¨è¯­æ³•ç³–çš„ç¬¬äºŒé˜¶æ®µ")
        
        @wraps(func)
        def wrapper(*args, **kwargs):
            print(f"ğŸ”¥ ç¬¬3å±‚æ‰§è¡Œ: wrapperè¢«è°ƒç”¨ï¼Œå‚æ•°{args}")
            print("   â†³ è¿™å‘ç”Ÿåœ¨ï¼šå®é™…è°ƒç”¨è¢«è£…é¥°çš„å‡½æ•°æ—¶")
            return func(*args, **kwargs) # è¿™é‡Œå¼€å§‹çœŸæ­£æ‰§è¡Œè¢«è£…é¥°çš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç»è¿‡ä¸€ç³»åˆ—çš„è£…é¥°æ“ä½œï¼ˆåšå…¶ä»–äº‹æƒ…ï¼‰ï¼Œç°åœ¨ç»ˆäºå¯ä»¥æ‰§è¡Œè¢«è£…é¥°çš„å‡½æ•°æœ¬ä½“äº†ï¼Œåšçš„ä¸€ç³»åˆ—æ“ä½œå®é™…ä¸Šå°±æ˜¯æ‰©å±•äº†è¢«è£…é¥°çš„åŸå‡½æ•°çš„åŠŸèƒ½
        """
            æ³¨æ„âš ï¸äº†æ³¨æ„âš ï¸äº†ï¼ä½ å¯èƒ½ç°åœ¨åˆä¸ç†è§£è£…é¥°å™¨äº†ï¼Œä½ å¯èƒ½æœ‰ä¸‹é¢çš„ç–‘é—®ï¼š
                å½“æˆ‘åœ¨è°ƒç”¨greet(25,'Alice')çš„æ—¶å€™ï¼Œæ˜¯ä¸æ˜¯å®é™…ä¸Šå°±ç›¸å½“äºè°ƒç”¨:wrapper(25,'Alice')?
            ç„¶åæˆ‘å‘ç°åœ¨wrapperå†…éƒ¨æ˜¯return func(*args, **kwargs)ï¼Œæ˜¯ä¸æ˜¯æ„æ€å°±æ˜¯ç›´æ¥åœ¨wrapperè¿”å›funcçš„æ‰§è¡Œç»“æœï¼Ÿ
            æ‰€ä»¥è¡¨ç°å‡ºæ¥çš„å°±æ˜¯æˆ‘è°ƒç”¨greet(25,'Alice')çš„æ—¶å€™ï¼Œå°±å¥½åƒå’Œæ²¡è£…é¥°çš„æ—¶å€™ä¸€æ ·ç›´æ¥æ‰§è¡Œçš„ï¼Ÿ
            âœ…æ²¡é”™ï¼Œæˆ‘çš„ä¸Šè¿°ç†è§£éƒ½æ˜¯æ­£ç¡®çš„ã€‚
            è£…é¥°å™¨çš„æœ¬è´¨
            1. è°ƒç”¨æ›¿æ¢ï¼šgreet(25, 'Alice') å®é™…ä¸Šå°±æ˜¯ wrapper(25, 'Alice')
                - å› ä¸ºè£…é¥°å greet å·²ç»æŒ‡å‘äº† wrapper å‡½æ•°å¯¹è±¡
            2. é€æ˜ä»£ç†ï¼šwrapper å†…éƒ¨çš„ return func(*args, **kwargs) ç¡®å®æ˜¯ï¼š
                - ç›´æ¥è¿”å›åŸå§‹å‡½æ•°çš„æ‰§è¡Œç»“æœ
                - func ä¿å­˜ç€åŸå§‹çš„ greet å‡½æ•°å¼•ç”¨
            3. ç”¨æˆ·ä½“éªŒï¼šè¡¨ç°å¾—"åƒæ²¡è£…é¥°ä¸€æ ·"æ˜¯å› ä¸ºï¼š
                - wrapper åšå®Œé¢å¤–å·¥ä½œï¼ˆå¦‚ç±»å‹æ£€æŸ¥ã€æ—¥å¿—ç­‰ï¼‰å
                - åŸæ ·è°ƒç”¨å¹¶è¿”å›åŸå‡½æ•°ç»“æœ
                - å¯¹å¤–æ¥å£ä¿æŒä¸€è‡´
            è°ƒç”¨é“¾ï¼šgreet(25, 'Alice') â†’ wrapper(25, 'Alice') â†’ ç›¸å½“äºæ˜¯è°ƒç”¨åŸå§‹çš„greet(25, 'Alice')ï¼Œå› ä¸ºwrapperä¼šè¿”å›è¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œç»“æœ
            è¿™å°±æ˜¯è£…é¥°å™¨çš„é€æ˜å¢å¼ºæ¨¡å¼ï¼šåœ¨ä¸æ”¹å˜åŸå‡½æ•°æ¥å£çš„å‰æä¸‹ï¼Œæ‰©å±•å…¶åŠŸèƒ½ã€‚
        """
        print(f"   â†³ decoratorè¿”å›wrapperå‡½æ•°å¯¹è±¡: {wrapper}") # è¿™é‡Œè¾“å‡ºï¼š <function greet at 0x1063b7380>ï¼Œå› ä¸ºè¢«åŒ…è£¹çš„å‡½æ•°åå­—å«åšgreetï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯function greet
        return wrapper
    
    print(f"   â†³ type_checkè¿”å›decoratorå‡½æ•°å¯¹è±¡: {decorator}") # ä¼šè¾“å‡ºï¼š<function type_check.<locals>.decorator at 0x1063b5b20>ï¼Œå…¶ä¸­çš„...<locals>.decoratorä¸­çš„decoratorå…¶å®å¯ä»¥è‡ªå®šä¹‰ï¼Œå’Œä½ å†™çš„å‡½æ•°åæœ‰å…³ï¼Œæ¯”å¦‚ä½ å«decorator1ï¼Œè¿™é‡Œå°±æ˜¯<locals>.decorator1
    return decorator

print("\n=== å…³é”®ç†è§£ï¼šè£…é¥°å™¨è¯­æ³•ç³–çš„ç­‰ä»·å½¢å¼ ===")

print("å½“ä½ å†™ï¼š")
print("@type_check(int, str)")
print("def my_func(a, b):")
print("    return a + b")

print("\nç­‰ä»·äºï¼š")
print("def my_func(a, b):")
print("    return a + b")
print("my_func = type_check(int, str)(my_func)") # ğŸ‘€è¿™é‡Œå®é™…ä¸Šéå¸¸æ¸…æ™°æ˜äº†äº†ï¼Œè¢«è£…é¥°çš„æ—¶å€™ï¼Œå…ˆæ‰§è¡Œtype_check(int, str)ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªç¬¬äºŒå±‚çš„decoratorï¼Œåˆå› ä¸ºtype_check(int, str)(my_func)çš„æœ€å³è¾¹åˆä¸ªå°æ‹¬å·ï¼Œå…¶å®å°±ç›¸å½“äºdecorator(my_func),è¿™å¾ˆæ˜æ˜¾äº†å§ï¼Œæ²¡é”™ï¼Œå°±æ˜¯æ‰§è¡Œè¿™ä¸ªdecoratorï¼Œæ‰€ä»¥ç¬¬äºŒå±‚æ‰ä¼šè¢«æ‰§è¡Œåˆ°

print("\nè®©æˆ‘ä»¬ä¸€æ­¥æ­¥åˆ†è§£ï¼š")
print("1. type_check(int, str)     â† ç¬¬1å±‚æ‰§è¡Œï¼Œè¿”å›decorator")
print("2. decorator(my_func)       â† ç¬¬2å±‚æ‰§è¡Œï¼Œè¿”å›wrapper")
print("3. my_func = wrapper        â† my_funcç°åœ¨æŒ‡å‘wrapper")

print("\n=== å®é™…æ¼”ç¤º ===")

print("å®šä¹‰è£…é¥°å™¨...")
# è£…é¥°å™¨å®šä¹‰æ—¶æ²¡æœ‰ä»»ä½•æ‰§è¡Œ

print("\nå¼€å§‹è£…é¥°å‡½æ•°...")

@type_check(int, str)  # è¿™é‡Œä¼šæ‰§è¡Œç¬¬1å±‚å’Œç¬¬2å±‚ï¼
def greet(age, name):
    """é—®å€™å‡½æ•°"""
    return f"Hello {name}, you are {age} years old"

print("\nè£…é¥°å®Œæˆï¼å‡½æ•°è¿˜æ²¡æœ‰è¢«è°ƒç”¨ã€‚")
print(f"greet ç°åœ¨æŒ‡å‘: {greet}") # è¾“å‡ºï¼š<function greet at 0x1063b7380>ï¼Œ è¿™æ˜¯ä¸€ä¸ªwrapperå¯¹è±¡ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå’Œè£…é¥°å™¨å†…éƒ¨è¾“å‡ºçš„wrapperçš„å¼•ç”¨æ˜¯ä¸€æ ·çš„
print(f"greet.__name__: {greet.__name__}")

print("\nç°åœ¨è°ƒç”¨å‡½æ•°...")
result = greet(25, "Alice")  # è¿™é‡Œæ‰æ‰§è¡Œç¬¬3å±‚wrapperï¼
print(f"è°ƒç”¨ç»“æœ: {result}")

print("\n=== ä¸ºä»€ä¹ˆç¬¬2å±‚decoratorä¼šç«‹å³æ‰§è¡Œï¼Ÿ ===")

print("å› ä¸ºè£…é¥°å™¨è¯­æ³•ç­‰ä»·äºä¸¤æ¬¡è¿ç»­çš„å‡½æ•°è°ƒç”¨ï¼š")

print("\næ‰‹åŠ¨æ¨¡æ‹Ÿè£…é¥°è¿‡ç¨‹ï¼š")
def manual_func(x, y):
    return x * y

print("æ­¥éª¤1: è°ƒç”¨ type_check(int, int)")
step1_result = type_check(int, int)  # ç¬¬1å±‚æ‰§è¡Œ
print(f"æ­¥éª¤1ç»“æœ: {step1_result} (è¿™æ˜¯decoratorå‡½æ•°)")

print("\næ­¥éª¤2: è°ƒç”¨ decorator(manual_func)")  
step2_result = step1_result(manual_func)  # ç¬¬2å±‚æ‰§è¡Œ
print(f"æ­¥éª¤2ç»“æœ: {step2_result} (è¿™æ˜¯wrapperå‡½æ•°)")

print("\nmanual_func ç°åœ¨æŒ‡å‘wrapper:")
manual_func = step2_result

print("\nè°ƒç”¨è£…é¥°åçš„å‡½æ•°:")
result = manual_func(3, 4)  # ç¬¬3å±‚æ‰§è¡Œ
print(f"æœ€ç»ˆç»“æœ: {result}")

print("\n=== æ‰§è¡Œæ—¶æœºæ€»ç»“ ===")
print("âœ… ç¬¬1å±‚ type_check():     åœ¨é‡åˆ°@è¯­æ³•æ—¶ç«‹å³æ‰§è¡Œ")
print("âœ… ç¬¬2å±‚ decorator():      åœ¨è£…é¥°è¿‡ç¨‹ä¸­ç«‹å³æ‰§è¡Œ")  
print("â° ç¬¬3å±‚ wrapper():        åªåœ¨å®é™…è°ƒç”¨å‡½æ•°æ—¶æ‰§è¡Œ")

print("\n=== è¯æ˜ï¼šè£…é¥°å™¨åœ¨å¯¼å…¥æ—¶å°±æ‰§è¡Œ ===")

print("å³ä½¿æˆ‘ä»¬ä¸è°ƒç”¨å‡½æ•°ï¼Œè£…é¥°è¿‡ç¨‹ä¹Ÿå·²ç»å®Œæˆï¼š")

@type_check(float, str, bool)
def never_called_function(price, name, active):
    """è¿™ä¸ªå‡½æ•°æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨"""
    return f"{name}: ${price}, active={active}"

print("çœ‹åˆ°äº†å—ï¼Ÿå³ä½¿ä¸è°ƒç”¨ never_called_functionï¼Œ")
print("ç¬¬1å±‚å’Œç¬¬2å±‚çš„ä»£ç ä¹Ÿå·²ç»æ‰§è¡Œäº†ï¼")

print("\n=== è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ¨¡å—å¯¼å…¥æ—¶è£…é¥°å™¨ä¼šæ‰§è¡Œ ===")
print("å½“Pythonå¯¼å…¥ä¸€ä¸ªæ¨¡å—æ—¶ï¼Œæ‰€æœ‰çš„@è£…é¥°å™¨éƒ½ä¼šç«‹å³æ‰§è¡Œå‰ä¸¤å±‚ä»£ç ï¼") 